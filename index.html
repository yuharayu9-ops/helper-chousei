<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CARE MATCH - PRO HYBRID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm">
            <h1 class="text-3xl font-black italic tracking-tighter text-slate-800">CARE MATCH</h1>
            <div class="text-right">
                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Local Processing Mode</p>
                <p class="text-[10px] text-slate-400">APIéä½¿ç”¨ / PDFãƒ»ç”»åƒå¯¾å¿œ</p>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-md">
                    <h2 class="font-black text-slate-700 mb-4 flex items-center">ğŸš« ç›¸æ€§NGãƒªã‚¹ãƒˆ</h2>
                    <div class="flex gap-2 mb-4">
                        <input id="ngU" placeholder="åˆ©ç”¨è€…" class="flex-1 p-2 bg-slate-50 rounded-lg text-sm border-none ring-1 ring-slate-200">
                        <input id="ngH" placeholder="ãƒ˜ãƒ«ãƒ‘ãƒ¼" class="flex-1 p-2 bg-slate-50 rounded-lg text-sm border-none ring-1 ring-slate-200">
                        <button onclick="addNG()" class="bg-red-500 text-white px-4 rounded-lg font-bold text-sm">ç™»éŒ²</button>
                    </div>
                    <div id="ngDisplay" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <label class="bg-blue-600 text-white p-6 rounded-[2rem] text-center font-bold cursor-pointer shadow-lg hover:bg-blue-700 transition-all">
                        <span class="block text-2xl">ğŸ‘¤</span> ãƒ˜ãƒ«ãƒ‘ãƒ¼èª­è¾¼
                        <input type="file" class="hidden" accept="image/*,.pdf" onchange="processFile(this, 'H')">
                    </label>
                    <label class="bg-emerald-600 text-white p-6 rounded-[2rem] text-center font-bold cursor-pointer shadow-lg hover:bg-emerald-700 transition-all">
                        <span class="block text-2xl">ğŸ </span> åˆ©ç”¨è€…èª­è¾¼
                        <input type="file" class="hidden" accept="image/*,.pdf" onchange="processFile(this, 'U')">
                    </label>
                </div>

                <div id="status" class="text-center p-4 text-xs font-bold text-slate-400 animate-pulse"></div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-md border-2 border-blue-100 overflow-hidden">
                <h2 class="font-black text-slate-700 mb-4 tracking-widest uppercase text-xs">Data Registry (ä¿®æ­£ãƒ»ç¢ºèª)</h2>
                <div id="registryList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    <p class="text-center text-slate-300 py-10 italic text-sm">ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </div>

        <div id="matchArea" class="space-y-4">
            <h2 class="font-black text-slate-400 tracking-[0.3em] uppercase text-[10px] px-4">Matching Result</h2>
            <div id="matchList" class="grid md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let registry = [];
        let ngList = JSON.parse(localStorage.getItem('cm_ng_list') || '[]');

        async function processFile(input, type) {
            const file = input.files[0];
            if (!file) return;
            const status = document.getElementById('status');
            status.innerText = "æ›¸é¡ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„";

            try {
                let source;
                if (file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    source = canvas.toDataURL('image/png');
                } else {
                    source = file;
                }

                const result = await Tesseract.recognize(source, 'jpn');
                const text = result.data.text;
                
                // OCRçµæœã‹ã‚‰ã€Œåå‰ã€ã€Œæ—¥ä»˜ã€ã€Œæ™‚é–“ã€ã‚’æ¨æ¸¬æŠ½å‡º
                const times = text.match(/(\d{1,2}[:ï¼š]\d{2})/g) || ["09:00", "18:00"];
                const name = text.split('\n').find(l => l.trim().length > 1 && !l.includes(':')) || "åå‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„";
                
                registry.push({
                    id: Date.now(),
                    type: type,
                    name: name.replace(/[ã•ã‚“æ§˜äºˆå®šè¡¨]/g, '').trim(),
                    start: times[0]?.replace('ï¼š', ':') || "09:00",
                    end: times[times.length-1]?.replace('ï¼š', ':') || "18:00"
                });

                renderRegistry();
                status.innerText = "";
            } catch (e) {
                status.innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼";
            }
        }

        function renderRegistry() {
            const list = document.getElementById('registryList');
            list.innerHTML = registry.map((item, i) => `
                <div class="p-4 rounded-2xl border ${item.type==='H'?'bg-blue-50 border-blue-100':'bg-emerald-50 border-emerald-100'}">
                    <div class="flex items-center gap-2 mb-2 text-[10px] font-bold ${item.type==='H'?'text-blue-400':'text-emerald-400'}">
                        <span>${item.type==='H'?'HELPER':'USER'}</span>
                    </div>
                    <input value="${item.name}" onchange="registry[${i}].name=this.value;runMatch()" class="w-full font-black bg-transparent border-b border-slate-300 mb-2 outline-none focus:border-slate-800">
                    <div class="flex gap-2">
                        <input type="time" value="${item.start}" onchange="registry[${i}].start=this.value;runMatch()" class="flex-1 text-xs p-1 rounded border">
                        <input type="time" value="${item.end}" onchange="registry[${i}].end=this.value;runMatch()" class="flex-1 text-xs p-1 rounded border">
                        <button onclick="registry.splice(${i},1);renderRegistry();runMatch()" class="text-red-400 font-bold px-1">Ã—</button>
                    </div>
                </div>
            `).join('');
            runMatch();
        }

        function runMatch() {
            const helpers = registry.filter(r => r.type === 'H');
            const users = registry.filter(r => r.type === 'U');
            const list = document.getElementById('matchList');
            
            list.innerHTML = users.map(u => {
                const hits = helpers.filter(h => {
                    const timeMatch = h.start <= u.start && h.end >= u.end;
                    const isNG = ngList.some(ng => (ng.u === u.name && ng.h === h.name) || (ng.u === h.name && ng.h === u.name));
                    return timeMatch && !isNG;
                });

                return `
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Target User</p>
                                <h3 class="font-black text-slate-800 text-lg tracking-tight">${u.name}</h3>
                            </div>
                            <span class="bg-slate-100 px-3 py-1 rounded-full text-[10px] font-bold font-mono">${u.start}-${u.end}</span>
                        </div>
                        <div class="space-y-2">
                            ${hits.map(h => `
                                <div class="bg-blue-600 text-white p-3 rounded-xl flex justify-between items-center shadow-md animate-in fade-in slide-in-from-bottom-2">
                                    <span class="font-bold text-sm">ğŸ‘¤ ${h.name}</span>
                                    <span class="text-[9px] font-black uppercase tracking-widest opacity-70">MATCHED</span>
                                </div>
                            `).join('') || '<p class="text-xs text-slate-300 italic p-2">å¯¾å¿œå¯èƒ½ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ã¯ã„ã¾ã›ã‚“</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addNG() {
            const u = document.getElementById('ngU').value.trim();
            const h = document.getElementById('ngH').value.trim();
            if(u && h) {
                ngList.push({u, h});
                localStorage.setItem('cm_ng_list', JSON.stringify(ngList));
                document.getElementById('ngU').value = ""; document.getElementById('ngH').value = "";
                renderNG(); runMatch();
            }
        }

        function renderNG() {
            document.getElementById('ngDisplay').innerHTML = ngList.map((ng, i) => `
                <div class="bg-red-50 text-red-500 border border-red-100 px-3 py-1 rounded-full text-[10px] font-bold flex items-center">
                    ${ng.u} Ã— ${ng.h} <button onclick="ngList.splice(${i},1);renderNG();runMatch()" class="ml-2 font-black">Ã—</button>
                </div>
            `).join('');
        }
        renderNG();
    </script>
</body>
</html>

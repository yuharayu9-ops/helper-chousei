<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªãË≠∑„Éû„ÉÉ„ÉÅ„É≥„Ç∞ AI v6.6</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            // --- Áä∂ÊÖãÁÆ°ÁêÜ („Éá„Éº„Çø‰øùÂ≠ò) ---
            const [helpers, setHelpers] = useState(() => JSON.parse(localStorage.getItem('cm_master_helpers') || '[]'));
            const [schedules, setSchedules] = useState(() => JSON.parse(localStorage.getItem('cm_monthly_schedules') || '[]'));
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key_v6') || '');
            const [activeTab, setActiveTab] = useState('matching');
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            useEffect(() => { localStorage.setItem('cm_master_helpers', JSON.stringify(helpers)); }, [helpers]);
            useEffect(() => { localStorage.setItem('cm_monthly_schedules', JSON.stringify(schedules)); }, [schedules]);
            useEffect(() => { localStorage.setItem('gemini_api_key_v6', apiKey); }, [apiKey]);

            // --- Ë≠¶Âëä„É≠„Ç∏„ÉÉ„ÇØ („ÉÄ„Éñ„É´„Éñ„ÉÉ„Ç≠„É≥„Ç∞Á≠â) ---
            const warnings = useMemo(() => {
                const results = [];
                schedules.forEach((s1, i) => {
                    if (!s1.helper || !s1.date || !s1.time) return;
                    // „ÉÄ„Éñ„É´„Éñ„ÉÉ„Ç≠„É≥„Ç∞„ÉÅ„Çß„ÉÉ„ÇØ
                    const conflict = schedules.find((s2, j) => 
                        i !== j && s1.helper === s2.helper && s1.date === s2.date && s1.time === s2.time
                    );
                    if (conflict) results.push({ index: i, type: 'double', msg: '‚ö†Ô∏è ÈáçË§á' });
                    
                    // NG„ÉÅ„Çß„ÉÉ„ÇØ
                    const helper = helpers.find(h => h.name === s1.helper);
                    if (helper && helper.ngClients && s1.client && helper.ngClients.includes(s1.client)) {
                        results.push({ index: i, type: 'ng', msg: '‚ùå NGÁµÑÂêà„Åõ' });
                    }
                });
                return results;
            }, [schedules, helpers]);

            // --- AI Studio ÂÜçÁèæË™≠„ÅøÂèñ„Çä ---
            const handleAIRead = async (e) => {
                const file = e.target.files[0];
                if (!file || !apiKey) { alert("API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
                setIsAnalyzing(true);
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64Data = reader.result.split(',')[1];
                    try {
                        // AI Studio„Å®Âêå„Åò v1beta / gemini-1.5-flash („Åæ„Åü„ÅØ pro) „Çí‰ΩøÁî®
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [
                                    { text: "‰ªãË≠∑‰æùÈ†ºÊõ∏„ÇíËß£Êûê„Åó„ÄÅ[{\"date\":\"YYYY-MM-DD\", \"time\":\"HH:MM\", \"client\":\"...\", \"service\":\"...\"}] „ÅÆÂΩ¢Âºè„ÅÆJSONÈÖçÂàó„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰∏çË¶Å„Å™Ë™¨Êòé„ÅØ‰∏ÄÂàáÁ¶ÅÊ≠¢„ÄÇ" }, 
                                    { inline_data: { mime_type: file.type, data: base64Data } }
                                ]}],
                                generationConfig: { temperature: 0.1 }
                            })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error.message);
                        const text = data.candidates[0].content.parts[0].text;
                        const json = JSON.parse(text.match(/\[[\s\S]*\]/)[0]);
                        setSchedules(prev => [...json, ...prev]);
                        alert(json.length + "‰ª∂„ÅÆ‰æùÈ†º„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ");
                    } catch (err) {
                        alert("AI Studio„Å®„ÅÆÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ1ÂàÜÂæÖ„Å£„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„Ç®„É©„Éº: " + err.message);
                    }
                    setIsAnalyzing(false);
                };
            };

            // --- CSV„Ç§„É≥„Éù„Éº„Éà (ÂêçÂâç„ÅÆ„ÅøÂØæÂøú) ---
            const handleCSV = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const names = event.target.result.split(/\r?\n/).filter(line => line.trim());
                    const newHelpers = names.map(name => ({ id: Date.now() + Math.random(), name: name.replace(/"/g, ''), ngClients: '' }));
                    setHelpers([...newHelpers, ...helpers]);
                    alert(newHelpers.length + "Âêç„ÅÆ„Éò„É´„Éë„Éº„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ");
                };
                reader.readAsText(file, "Shift_JIS");
            };

            return (
                <div className="max-w-6xl mx-auto my-5 bg-white shadow-2xl rounded-2xl overflow-hidden border border-slate-200">
                    <header className="bg-slate-900 text-white p-5 flex justify-between items-center border-b-4 border-blue-500">
                        <div>
                            <h1 className="text-xl font-black tracking-tighter">CARE MATCH v6.6</h1>
                            <p className="text-[10px] text-blue-400 font-bold uppercase">AI Studio Engine & Safety Logic</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <input type="password" placeholder="API Key" className="bg-slate-800 text-xs p-2 rounded border border-slate-700 w-48 outline-none focus:ring-1 focus:ring-blue-500" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
                        </div>
                    </header>

                    <nav className="flex bg-slate-50 border-b">
                        <button onClick={()=>setActiveTab('matching')} className={`flex-1 p-4 font-bold ${activeTab==='matching'?'bg-white text-blue-600 border-b-4 border-blue-600 shadow-inner':'text-slate-400'}`}>üìÖ ‰æùÈ†ºË™≠Ëæº„Éª„Éû„ÉÉ„ÉÅ„É≥„Ç∞</button>
                        <button onClick={()=>setActiveTab('ledger')} className={`flex-1 p-4 font-bold ${activeTab==='ledger'?'bg-white text-blue-600 border-b-4 border-blue-600 shadow-inner':'text-slate-400'}`}>üë• Âè∞Â∏≥ÁÆ°ÁêÜ ({helpers.length}Âêç)</button>
                    </nav>

                    <main className="p-6 min-h-[600px]">
                        {activeTab === 'matching' ? (
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <label className="md:col-span-2 flex flex-col items-center justify-center bg-blue-600 text-white p-6 rounded-3xl cursor-pointer hover:bg-blue-700 shadow-lg transition-all active:scale-95">
                                        <span className="text-2xl mb-1">üìÅ</span>
                                        <span className="font-bold">PDF/ÁîªÂÉè„Åã„Çâ‰∏ÄÊã¨Ë™≠„ÅøËæº„Åø</span>
                                        <input type="file" className="hidden" accept="application/pdf,image/*" onChange={handleAIRead} />
                                    </label>
                                    <button onClick={()=>setSchedules([{id:Date.now(), date:'', time:'', client:'', service:'', helper:''}, ...schedules])} className="bg-slate-800 text-white p-6 rounded-3xl font-bold hover:bg-slate-900 shadow-md">
                                        ‚ûï ÊâãÂãï„Åß1‰ª∂ËøΩÂä†
                                    </button>
                                </div>

                                <div className="border rounded-2xl overflow-hidden bg-white shadow-sm overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-900 text-white">
                                            <tr>
                                                <th className="p-3 border-r border-slate-700">Êó•ÊôÇ</th>
                                                <th className="p-3 border-r border-slate-700">Âà©Áî®ËÄÖÂêç</th>
                                                <th className="p-3 border-r border-slate-700">ÂÜÖÂÆπ</th>
                                                <th className="p-3 text-blue-400">ÊãÖÂΩì„Éò„É´„Éë„Éº</th>
                                                <th className="p-3"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {schedules.map((s, i) => {
                                                const hasWarning = warnings.find(w => w.index === i);
                                                return (
                                                    <tr key={i} className={`border-b ${hasWarning ? 'bg-red-50' : 'hover:bg-blue-50/30'}`}>
                                                        <td className="p-2 border-r">
                                                            <input type="date" className="block w-full text-xs" value={s.date} onChange={(e)=>{const n=[...schedules]; n[i].date=e.target.value; setSchedules(n)}}/>
                                                            <input type="time" className="block w-full text-xs mt-1" value={s.time} onChange={(e)=>{const n=[...schedules]; n[i].time=e.target.value; setSchedules(n)}}/>
                                                        </td>
                                                        <td className="p-2 border-r"><input className="w-full font-bold p-1 bg-transparent border-b border-transparent focus:border-blue-400 outline-none" value={s.client} placeholder="Âà©Áî®ËÄÖ" onChange={(e)=>{const n=[...schedules]; n[i].client=e.target.value; setSchedules(n)}}/></td>
                                                        <td className="p-2 border-r"><input className="w-full p-1 bg-transparent border-b border-transparent focus:border-blue-400 outline-none" value={s.service} placeholder="ÊéÉÈô§„ÉªÂÖ•Êµ¥Á≠â" onChange={(e)=>{const n=[...schedules]; n[i].service=e.target.value; setSchedules(n)}}/></td>
                                                        <td className="p-2 border-r relative">
                                                            <select className="w-full p-2 font-bold text-blue-600 rounded bg-transparent" value={s.helper} onChange={(e)=>{const n=[...schedules]; n[i].helper=e.target.value; setSchedules(n)}}>
                                                                <option value="">‚ñº Êú™ÈÅ∏Êäû</option>
                                                                {helpers.map(h=><option key={h.id} value={h.name}>{h.name}</option>)}
                                                            </select>
                                                            {hasWarning && <span className="absolute -top-1 right-1 text-[10px] bg-red-600 text-white px-1 rounded font-bold animate-pulse">{hasWarning.msg}</span>}
                                                        </td>
                                                        <td className="p-2 text-center"><button onClick={()=>setSchedules(schedules.filter((_,idx)=>idx!==i))} className="text-slate-300 hover:text-red-500 font-bold">‚úï</button></td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="flex justify-between">
                                    <button onClick={()=>{if(confirm('„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü'))setSchedules([])}} className="text-xs text-red-500 underline px-2">ÂÖ®‰æùÈ†º„ÇíÂâäÈô§</button>
                                    <p className="text-[10px] text-slate-400">‚Äª„Éá„Éº„Çø„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</p>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={()=>setHelpers([{id:Date.now(), name:'', ngClients:''}, ...helpers])} className="p-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg hover:bg-slate-900">+ ÊâãÂãï„Åß„Éò„É´„Éë„ÉºÁôªÈå≤</button>
                                    <label className="p-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-lg hover:bg-emerald-700 text-center cursor-pointer">
                                        üì• CSV„Åã„ÇâÂêçÂâç„Çí‰∏ÄÊã¨ÁôªÈå≤
                                        <input type="file" className="hidden" accept=".csv" onChange={handleCSV} />
                                    </label>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {helpers.map(h => (
                                        <div key={h.id} className="p-4 border-2 border-slate-100 rounded-3xl bg-white shadow-sm relative group hover:border-blue-300 transition-all">
                                            <button onClick={()=>setHelpers(helpers.filter(x=>x.id!==h.id))} className="absolute top-4 right-4 text-slate-200 hover:text-red-500 transition-all font-bold">‚úï</button>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Helper Name</label>
                                                    <input className="font-bold border-b-2 w-full text-lg outline-none focus:border-blue-400 py-1" value={h.name} placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" onChange={(e)=>{const n=[...helpers]; n.find(x=>x.id===h.id).name=e.target.value; setHelpers(n)}} />
                                                </div>
                                                <div>
                                                    <label className="text-[9px] text-red-400 font-bold uppercase tracking-widest">NGÂà©Áî®ËÄÖ („Ç´„É≥„ÉûÂå∫Âàá„Çä)</label>
                                                    <input className="w-full text-xs border-2 border-slate-50 p-2 rounded-xl bg-slate-50 focus:bg-white focus:border-red-100 outline-none" value={h.ngClients} placeholder="‰æã: Áî∞‰∏≠, ‰ΩêËó§" onChange={(e)=>{const n=[...helpers]; n.find(x=>x.id===h.id).ngClients=e.target.value; setHelpers(n)}} />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {helpers.length > 0 && <button onClick={()=>{if(confirm('ÂÖ®Âè∞Â∏≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü'))setHelpers([])}} className="text-xs text-red-500 underline">Âè∞Â∏≥„Çí‰∏ÄÊã¨ÂâäÈô§</button>}
                            </div>
                        )}
                    </main>

                    {isAnalyzing && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md flex flex-col items-center justify-center z-50">
                            <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p className="text-white font-bold text-xl animate-pulse tracking-widest">AI STUDIO ENGINE ANALYZING...</p>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

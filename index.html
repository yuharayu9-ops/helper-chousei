<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CARE MATCH - FULL AUTOMATED</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 p-4">
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [helpers, setHelpers] = useState([]);
            const [users, setUsers] = useState([]);
            const [apiKey, setApiKey] = useState(localStorage.getItem('cm_final_key') || '');
            const [status, setStatus] = useState('å¾…æ©Ÿä¸­');

            const callGemini = async (base64) => {
                // ã€404å¯¾ç­–ã€‘URLã®æœ€å¾Œã«ãƒ¢ãƒ‡ãƒ«åã‚’çµåˆã™ã‚‹ã®ã§ã¯ãªãã€ãƒ‘ã‚¹ã¨ã—ã¦æŒ‡å®š
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "ç”»åƒã‹ã‚‰æ°å(name)ã¨ç¨¼åƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«(schedule:[{date,startTime,endTime}])ã‚’JSONå½¢å¼ã§æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚ä½™è¨ˆãªè§£èª¬ã¯ä¸è¦ã§ã™ã€‚" },
                                { inline_data: { mime_type: "image/jpeg", data: base64 } }
                            ]
                        }]
                    })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                const text = data.candidates[0].content.parts[0].text;
                return JSON.parse(text.match(/\{[\s\S]*\}|\[[\s\S]*\]/)[0]);
            };

            const handleUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert("APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    setStatus(`${type === 'H' ? 'ãƒ˜ãƒ«ãƒ‘ãƒ¼' : 'åˆ©ç”¨è€…'}ã®ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...`);
                    try {
                        const base64 = reader.result.split(',')[1];
                        const result = await callGemini(base64);
                        if (type === 'H') setHelpers(prev => [...prev, result]);
                        else setUsers(prev => [...prev, result]);
                        setStatus('èª­ã¿è¾¼ã¿å®Œäº†');
                        localStorage.setItem('cm_final_key', apiKey);
                    } catch (err) {
                        setStatus(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
                    }
                };
            };

            // è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
            const getMatches = () => {
                const matches = [];
                users.forEach(u => {
                    u.schedule.forEach(uSched => {
                        const availableHelpers = helpers.filter(h => 
                            h.schedule.some(hSched => 
                                hSched.date === uSched.date &&
                                hSched.startTime <= uSched.startTime &&
                                hSched.endTime >= uSched.endTime
                            )
                        );
                        matches.push({ user: u.name, date: uSched.date, time: `${uSched.startTime}-${uSched.endTime}`, helpers: availableHelpers });
                    });
                });
                return matches;
            };

            return (
                <div className="max-w-2xl mx-auto bg-white p-8 rounded-3xl shadow-xl border border-slate-200">
                    <div className="flex justify-between items-center mb-8 border-b pb-4">
                        <h1 className="text-2xl font-black italic tracking-tighter">CARE MATCH</h1>
                        <input type="password" placeholder="API Key" className="bg-slate-50 p-2 rounded text-xs border" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <label className="p-6 bg-blue-600 text-white rounded-2xl text-center cursor-pointer font-bold active:scale-95 transition-all">
                            ãƒ˜ãƒ«ãƒ‘ãƒ¼ç”»åƒ èª­è¾¼
                            <input type="file" className="hidden" onChange={(e)=>handleUpload(e, 'H')} />
                        </label>
                        <label className="p-6 bg-emerald-600 text-white rounded-2xl text-center cursor-pointer font-bold active:scale-95 transition-all">
                            åˆ©ç”¨è€…ç”»åƒ èª­è¾¼
                            <input type="file" className="hidden" onChange={(e)=>handleUpload(e, 'U')} />
                        </label>
                    </div>

                    <div className="mb-8 p-4 bg-slate-50 rounded-xl text-center font-bold text-blue-600">
                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {status}
                    </div>

                    <div className="space-y-6">
                        <h2 className="font-black text-slate-800 border-l-4 border-slate-800 pl-2 uppercase tracking-widest">Matching Results</h2>
                        {getMatches().map((m, i) => (
                            <div key={i} className="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <div className="flex justify-between font-bold mb-3">
                                    <span>ğŸ  {m.user}</span>
                                    <span className="text-sm text-slate-500">{m.date} {m.time}</span>
                                </div>
                                <div className="space-y-2">
                                    {m.helpers.length > 0 ? m.helpers.map((h, j) => (
                                        <div key={j} className="bg-white p-3 rounded-xl shadow-sm text-sm font-bold text-blue-600 border border-blue-100">
                                            ğŸ‘¤ {h.name} ã•ã‚“ãŒå¯¾å¿œå¯èƒ½ã§ã™
                                        </div>
                                    )) : <p className="text-xs text-slate-400">ãƒãƒƒãƒã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã¯ã„ã¾ã›ã‚“</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

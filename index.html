<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CARE MATCH - AI VISION EDITION</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        function App() {
            const [helpers, setHelpers] = useState([]);
            const [users, setUsers] = useState([]);
            const [apiKey, setApiKey] = useState(localStorage.getItem('cm_key_vision') || '');
            const [status, setStatus] = useState('å¾…æ©Ÿä¸­');
            const [ngList, setNgList] = useState(() => JSON.parse(localStorage.getItem('cm_ng') || '[]'));

            const callGeminiAI = async (base64) => {
                // ã€404ã‚’å›é¿ã™ã‚‹æœ€æ–°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ§‹é€ ã€‘
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "ã“ã®äºˆå®šè¡¨ã‹ã‚‰ã€æ°åã¨ç¨¼åƒæ™‚é–“ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ï¼‰ã‚’ã™ã¹ã¦æŠœãå‡ºã—ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚æ‰‹æ›¸ãæ–‡å­—ã‚‚æ³¨æ„æ·±ãèª­ã‚“ã§ã€‚{\"data\": [{\"name\": \"åå‰\", \"startTime\": \"HH:mm\", \"endTime\": \"HH:mm\"}]}" },
                                { inline_data: { mime_type: "image/jpeg", data: base64 } }
                            ]
                        }]
                    })
                });

                const resData = await response.json();
                if (resData.error) throw new Error(resData.error.message);
                
                const jsonStr = resData.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/)[0];
                return JSON.parse(jsonStr).data;
            };

            const handleFile = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                setStatus("AIãŒè§£æä¸­...ï¼ˆæ–‡å­—åŒ–ã‘ã‚’é˜²ããŸã‚é«˜åº¦ãªã‚¹ã‚­ãƒ£ãƒ³ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼‰");
                
                try {
                    let base64;
                    if (file.type === "application/pdf") {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        const page = await pdf.getPage(1);
                        const canvas = document.createElement('canvas');
                        const viewport = page.getViewport({ scale: 2.0 });
                        canvas.height = viewport.height; canvas.width = viewport.width;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                        base64 = canvas.toDataURL('image/jpeg').split(',')[1];
                    } else {
                        const reader = new FileReader();
                        base64 = await new Promise(res => {
                            reader.readAsDataURL(file);
                            reader.onload = () => res(reader.result.split(',')[1]);
                        });
                    }

                    const extracted = await callGeminiAI(base64);
                    if (type === 'H') setHelpers([...helpers, ...extracted]);
                    else setUsers([...users, ...extracted]);
                    setStatus("è§£ææˆåŠŸï¼");
                    localStorage.setItem('cm_key_vision', apiKey);
                } catch (err) {
                    setStatus(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
                    console.error(err);
                }
            };

            const matches = [];
            users.forEach(u => {
                const hits = helpers.filter(h => {
                    const timeOK = h.startTime <= u.startTime && h.endTime >= u.endTime;
                    const isNG = ngList.some(ng => (ng.u === u.name && ng.h === h.name) || (ng.u === h.name && ng.h === u.name));
                    return timeOK && !isNG;
                });
                matches.push({ user: u, hits });
            });

            return (
                <div className="max-w-2xl mx-auto p-6">
                    <header className="flex justify-between items-center mb-10 bg-white p-6 rounded-[2rem] shadow-sm">
                        <h1 className="text-3xl font-black italic tracking-tighter">CARE MATCH</h1>
                        <input type="password" placeholder="AI Studio Key" className="p-2 border rounded-xl text-xs" value={apiKey} onChange={e=>setApiKey(e.target.value)} />
                    </header>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <label className="bg-blue-600 text-white p-8 rounded-[2.5rem] text-center font-bold shadow-xl active:scale-95 cursor-pointer">
                            ğŸ‘¤ ãƒ˜ãƒ«ãƒ‘ãƒ¼èª­è¾¼
                            <input type="file" className="hidden" onChange={e=>handleFile(e, 'H')} />
                        </label>
                        <label className="bg-emerald-600 text-white p-8 rounded-[2.5rem] text-center font-bold shadow-xl active:scale-95 cursor-pointer">
                            ğŸ  åˆ©ç”¨è€…èª­è¾¼
                            <input type="file" className="hidden" onChange={e=>handleFile(e, 'U')} />
                        </label>
                    </div>

                    <div className="bg-white p-4 rounded-2xl mb-10 text-center text-sm font-bold text-blue-500 shadow-inner italic">Status: {status}</div>

                    <div className="space-y-6">
                        <h2 className="text-xs font-black text-slate-300 uppercase tracking-widest px-4">Automatic Matches</h2>
                        {matches.map((m, i) => (
                            <div key={i} className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                                <div className="flex justify-between mb-4 border-b pb-2">
                                    <span className="font-black text-slate-800">ğŸ  {m.user.name}</span>
                                    <span className="text-xs font-bold text-slate-400">{m.user.startTime} - {m.user.endTime}</span>
                                </div>
                                <div className="space-y-2">
                                    {m.hits.map((h, j) => (
                                        <div key={j} className="bg-blue-50 text-blue-600 p-4 rounded-2xl flex justify-between items-center font-bold">
                                            <span>ğŸ‘¤ {h.name}</span>
                                            <span className="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-full uppercase">Possible</span>
                                        </div>
                                    ))}
                                    {m.hits.length === 0 && <p className="text-xs text-slate-300 italic">æ¡ä»¶ã«åˆã†ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

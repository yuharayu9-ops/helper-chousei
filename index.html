<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareMatch AI PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-static@0.321.0/lib/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- AI Studioã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ç§»æ¤ ---
        const App = () => {
            const [helpers, setHelpers] = useState(() => JSON.parse(localStorage.getItem('cm_pro_h') || '[]'));
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('cm_pro_u') || '[]'));
            const [matches, setMatches] = useState(() => JSON.parse(localStorage.getItem('cm_pro_m') || '[]'));
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('cm_pro_k') || '');
            const [activeTab, setActiveTab] = useState('input');
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('');

            useEffect(() => {
                localStorage.setItem('cm_pro_h', JSON.stringify(helpers));
                localStorage.setItem('cm_pro_u', JSON.stringify(users));
                localStorage.setItem('cm_pro_m', JSON.stringify(matches));
                localStorage.setItem('cm_pro_k', apiKey);
            }, [helpers, users, matches, apiKey]);

            // ç”»åƒè§£æï¼ˆAI Studioç‰ˆã®å‘½ä»¤ã‚’ç›´è¼¸å…¥ï¼‰
            const handleFileUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                setLoading(true);
                setStatus('AIãŒç”»åƒã‚’è§£æä¸­...');

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    const prompt = type === 'HELPER' 
                        ? "ç”»åƒã‹ã‚‰ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®æ°åã€å¯¾å¿œå¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ï¼ˆç§»å‹•æ”¯æ´ãƒ»è¡Œå‹•æ´è­·ãƒ»é‡åº¦è¨ªå•ä»‹è­·ãƒ»å±…å®…ä»‹è­·ã‹ã‚‰é¸æŠï¼‰ã€ç¨¼åƒå¯èƒ½æ™‚é–“ã‚’æŠ½å‡ºã—ã¦JSONã§å‡ºã—ã¦ãã ã•ã„ã€‚2026å¹´ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚"
                        : "ç”»åƒã‹ã‚‰åˆ©ç”¨è€…ã®æ°åã€å¸Œæœ›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹åã€åˆ©ç”¨å¸Œæœ›æ™‚é–“ã‚’æŠ½å‡ºã—ã¦JSONã§å‡ºã—ã¦ãã ã•ã„ã€‚2026å¹´ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚";

                    try {
                        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [
                                    { inline_data: { mime_type: "image/jpeg", data: base64 } },
                                    { text: prompt + "\nå¿…ãš [ ] ã§å›²ã¾ã‚ŒãŸJSONå½¢å¼ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚" }
                                ] }]
                            })
                        });
                        const data = await resp.json();
                        const aiText = data.candidates[0].content.parts[0].text;
                        const res = JSON.parse(aiText.match(/\{[\s\S]*\}|\[[\s\S]*\]/)[0]);

                        if (type === 'HELPER') {
                            setHelpers([...helpers, { id: Date.now().toString(), name: res.name || 'æ–°è¦ãƒ˜ãƒ«ãƒ‘ãƒ¼', availability: res.schedule || [], services: res.services || ['å±…å®…ä»‹è­·'] }]);
                        } else {
                            setUsers([...users, { id: Date.now().toString(), name: res.name || 'æ–°è¦åˆ©ç”¨è€…', requests: res.schedule || [], requiredService: res.service || 'å±…å®…ä»‹è­·' }]);
                        }
                        setStatus('èª­ã¿è¾¼ã¿æˆåŠŸï¼');
                    } catch (err) {
                        alert("è§£æå¤±æ•—ã€‚APIã‚­ãƒ¼ã¾ãŸã¯ç”»åƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    } finally { setLoading(false); }
                };
            };

            // è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°ï¼ˆAI Studioç‰ˆãƒ‘ã‚ºãƒ«ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            const startMatching = async () => {
                if (!apiKey) return alert("APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™");
                setLoading(true);
                setStatus('æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’è¨ˆç®—ä¸­...');
                const prompt = `ä»¥ä¸‹ã®ã‚¹ã‚¿ãƒƒãƒ•ã¨åˆ©ç”¨è€…ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã€æ™‚é–“ãŒé‡ãªã‚Šã€ã‹ã¤ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€è‡´ã™ã‚‹çµ„ã¿åˆã‚ã›ã‚’JSONã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\nãƒ˜ãƒ«ãƒ‘ãƒ¼: ${JSON.stringify(helpers)}\nåˆ©ç”¨è€…: ${JSON.stringify(users)}`;

                try {
                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt + "\nå½¢å¼: [{\"date\":\"...\",\"startTime\":\"...\",\"endTime\":\"...\",\"helperName\":\"...\",\"userName\":\"...\",\"serviceType\":\"...\",\"reason\":\"...\"}]" }] }] })
                    });
                    const data = await resp.json();
                    const res = JSON.parse(data.candidates[0].content.parts[0].text.match(/\[[\s\S]*\]/)[0]);
                    setMatches(res);
                    setActiveTab('result');
                } catch (err) {
                    alert("ãƒãƒƒãƒãƒ³ã‚°å¤±æ•—");
                } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-indigo-600 text-white p-4 shadow-lg no-print">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-black italic">CareMatch AI PRO</h1>
                            <div className="flex gap-2">
                                <input type="password" placeholder="API Key" className="text-slate-900 text-xs p-2 rounded-lg outline-none w-32 md:w-64" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
                                <button onClick={() => setActiveTab('input')} className={`px-4 py-2 rounded-lg text-xs font-bold ${activeTab === 'input' ? 'bg-white text-indigo-700' : 'bg-indigo-500'}`}>å…¥åŠ›</button>
                                <button onClick={() => setActiveTab('result')} className={`px-4 py-2 rounded-lg text-xs font-bold ${activeTab === 'result' ? 'bg-white text-indigo-700' : 'bg-indigo-500'}`}>çµæœ</button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-6">
                        {activeTab === 'input' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-indigo-100 text-center">
                                        <h3 className="font-bold text-indigo-900 mb-4">â‘  ãƒ˜ãƒ«ãƒ‘ãƒ¼äºˆå®šè¡¨ã‚’æ’®å½±</h3>
                                        <input type="file" onChange={(e) => handleFileUpload(e, 'HELPER')} className="text-xs border p-4 rounded-2xl w-full" />
                                    </div>
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-emerald-100 text-center">
                                        <h3 className="font-bold text-emerald-900 mb-4">â‘¡ åˆ©ç”¨è€…å¸Œæœ›è¡¨ã‚’æ’®å½±</h3>
                                        <input type="file" onChange={(e) => handleFileUpload(e, 'USER')} className="text-xs border p-4 rounded-2xl w-full" />
                                    </div>
                                    <button onClick={startMatching} disabled={loading} className="w-full bg-indigo-600 text-white py-6 rounded-[2rem] font-black text-xl shadow-xl hover:bg-indigo-700 transition-all active:scale-95">
                                        {loading ? 'AIè¨ˆç®—ä¸­...' : 'ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ âœ¨'}
                                    </button>
                                    <p className="text-center text-slate-400 text-xs font-bold">{status}</p>
                                </div>

                                <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 min-h-[400px]">
                                    <h3 className="font-bold mb-4 flex justify-between">ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ <span>(H:{helpers.length} / U:{users.length})</span></h3>
                                    <div className="space-y-4">
                                        {helpers.map(h => <div key={h.id} className="p-3 bg-slate-50 rounded-xl text-sm font-bold flex justify-between">ğŸ‘¤ {h.name} <button onClick={()=>setHelpers(helpers.filter(x=>x.id!==h.id))} className="text-slate-300">Ã—</button></div>)}
                                        {users.map(u => <div key={u.id} className="p-3 bg-emerald-50 rounded-xl text-sm font-bold flex justify-between">ğŸ  {u.name} <button onClick={()=>setUsers(users.filter(x=>x.id!==u.id))} className="text-slate-300">Ã—</button></div>)}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'result' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center no-print">
                                    <h2 className="text-2xl font-black">AIãƒãƒƒãƒãƒ³ã‚°çµæœ</h2>
                                    <button onClick={() => window.print()} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold">PDFä¿å­˜ãƒ»å°åˆ·</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {matches.map((m, i) => (
                                        <div key={i} className="bg-white p-6 rounded-[2rem] border-2 border-indigo-500 shadow-lg">
                                            <div className="text-[10px] font-black bg-indigo-100 text-indigo-700 px-2 py-1 rounded inline-block mb-2">{m.date}</div>
                                            <div className="font-black text-lg mb-1">{m.helperName} â†’ {m.userName}</div>
                                            <div className="text-xs text-slate-500 mb-3">{m.startTime}ï½{m.endTime} ({m.serviceType})</div>
                                            <div className="text-[10px] bg-slate-50 p-2 rounded-lg leading-relaxed italic text-slate-400">{m.reason}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

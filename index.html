<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CARE MATCH - THE FINAL INTEGRATION</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [helpers, setHelpers] = useState(() => JSON.parse(localStorage.getItem('cm_h') || '[]'));
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('cm_u') || '[]'));
            const [apiKey, setApiKey] = useState(localStorage.getItem('cm_key') || '');
            const [status, setStatus] = useState('ÂæÖÊ©ü‰∏≠');

            useEffect(() => {
                localStorage.setItem('cm_h', JSON.stringify(helpers));
                localStorage.setItem('cm_u', JSON.stringify(users));
                localStorage.setItem('cm_key', apiKey);
            }, [helpers, users, apiKey]);

            const callGemini = async (base64) => {
                // „Äê404Ê†πÁµ∂„ÅÆÊúÄÁµÇÊåáÂÆö„Äë
                // gemini-1.5-flash „Åß„ÅØ„Å™„Åè„ÄÅ„É™„É™„Éº„ÇπÁï™Âè∑‰ªò„Åç„ÅÆ ID „ÇíÁõ¥Êé•Âè©„Åç„Åæ„Åô
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "ÁîªÂÉè„Åã„ÇâÊ∞èÂêç(name)„Å®Á®ºÂÉç„Çπ„Ç±„Ç∏„É•„Éº„É´(schedule:[{date,startTime,endTime}])„ÇíJSON„ÅßÊäΩÂá∫„ÄÇÊó•‰ªò„ÅØYYYY-MM-DDÂΩ¢Âºè„ÄÅÊôÇÈñì„ÅØHH:MMÂΩ¢Âºè„Åß„ÄÇ" },
                                { inline_data: { mime_type: "image/jpeg", data: base64 } }
                            ]
                        }]
                    })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(`${data.error.message} (${data.error.code})`);
                
                const jsonText = data.candidates[0].content.parts[0].text;
                const match = jsonText.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                return JSON.parse(match[0]);
            };

            const handleFile = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert("API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                setStatus('AIËß£Êûê‰∏≠...');
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        const res = await callGemini(reader.result.split(',')[1]);
                        if (type === 'H') setHelpers([...helpers, res]);
                        else setUsers([...users, res]);
                        setStatus('Ë™≠„ÅøËæº„ÅøÊàêÂäü');
                    } catch (err) {
                        setStatus(`„Ç®„É©„Éº: ${err.message}`);
                    }
                };
            };

            const getMatches = () => {
                const results = [];
                users.forEach(u => {
                    u.schedule?.forEach(uS => {
                        const hit = helpers.filter(h => 
                            h.schedule?.some(hS => 
                                hS.date === uS.date && hS.startTime <= uS.startTime && hS.endTime >= uS.endTime
                            )
                        );
                        results.push({ user: u.name, date: uS.date, time: `${uS.startTime}-${uS.endTime}`, helpers: hit });
                    });
                });
                return results;
            };

            return (
                <div className="max-w-xl mx-auto my-10 bg-white p-8 rounded-[3rem] shadow-2xl border border-slate-100">
                    <header className="mb-8 flex justify-between items-center">
                        <h1 className="font-black italic text-2xl text-slate-800 tracking-tighter">CARE MATCH</h1>
                        <input type="password" placeholder="Key" className="bg-slate-50 p-2 rounded-xl text-[10px] w-32 border" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
                    </header>

                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <label className="p-8 bg-blue-600 text-white rounded-[2rem] text-center cursor-pointer shadow-lg active:scale-95 transition-all">
                            <span className="text-2xl block mb-2">üë§</span>
                            <span className="font-bold text-[10px] uppercase">Helper Scan</span>
                            <input type="file" className="hidden" onChange={(e)=>handleFile(e, 'H')} />
                        </label>
                        <label className="p-8 bg-emerald-600 text-white rounded-[2rem] text-center cursor-pointer shadow-lg active:scale-95 transition-all">
                            <span className="text-2xl block mb-2">üè†</span>
                            <span className="font-bold text-[10px] uppercase">User Scan</span>
                            <input type="file" className="hidden" onChange={(e)=>handleFile(e, 'U')} />
                        </label>
                    </div>

                    <div className="bg-slate-50 p-4 rounded-2xl text-center text-xs font-bold text-blue-500 mb-8 italic">Status: {status}</div>

                    <div className="space-y-4">
                        <h2 className="text-[10px] font-black text-slate-300 uppercase tracking-widest px-2">Matches Found</h2>
                        {getMatches().map((m, i) => (
                            <div key={i} className="p-5 bg-white border border-slate-100 rounded-[2rem] shadow-sm">
                                <div className="flex justify-between font-black text-slate-800 mb-2">
                                    <span>üè† {m.user}</span>
                                    <span className="text-[10px] text-slate-400">{m.date} {m.time}</span>
                                </div>
                                {m.helpers.map((h, j) => (
                                    <div key={j} className="text-sm font-bold text-blue-600 mt-2">‚úì {h.name} „Åï„Çì„ÅåÂØæÂøúÂèØËÉΩ</div>
                                ))}
                            </div>
                        ))}
                    </div>
                    <button onClick={()=>{setHelpers([]);setUsers([]);}} className="w-full mt-10 text-[10px] text-slate-300 font-bold uppercase tracking-widest">Clear All Data</button>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

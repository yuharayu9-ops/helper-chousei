<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CARE MATCH PRO - FINAL</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [helpers, setHelpers] = useState(() => JSON.parse(localStorage.getItem('cm_final_h') || '[]'));
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('cm_final_u') || '[]'));
            const [matches, setMatches] = useState(() => JSON.parse(localStorage.getItem('cm_final_m') || '[]'));
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('cm_final_k') || '');
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('æº–å‚™å®Œäº†');

            useEffect(() => {
                localStorage.setItem('cm_final_h', JSON.stringify(helpers));
                localStorage.setItem('cm_final_u', JSON.stringify(users));
                localStorage.setItem('cm_final_m', JSON.stringify(matches));
                localStorage.setItem('cm_final_k', apiKey);
            }, [helpers, users, matches, apiKey]);

            // AI StudioãŒã€ŒæˆåŠŸã€ã—ã¦ã„ã‚‹é€šä¿¡æ–¹æ³•ã‚’å®Œå…¨ã«å†ç¾
            const callGemini = async (base64, prompt) => {
                // v1betaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã„ã€AI Studioã¨åŒã˜ã€ŒgenerationConfigã€ã‚’è¨­å®š
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: "image/jpeg", data: base64 } },
                                { text: prompt }
                            ]
                        }],
                        generationConfig: {
                            temperature: 1,
                            topP: 0.95,
                            topK: 40,
                            maxOutputTokens: 8192,
                            responseMimeType: "application/json"
                        }
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            };

            const handleFileUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                setLoading(true);
                setStatus('è§£æä¸­...');
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    const prompt = type === 'HELPER' 
                        ? "Extract helper name, services (ç§»å‹•æ”¯æ´, è¡Œå‹•æ´è­·, é‡åº¦è¨ªå•ä»‹è­·, å±…å®…ä»‹è­·), and availability as JSON: {\"name\":\"\", \"services\":[], \"schedule\":[{\"date\":\"YYYY-MM-DD\", \"startTime\":\"HH:MM\", \"endTime\":\"HH:MM\"}]}"
                        : "Extract user name, required service, and requests as JSON: {\"name\":\"\", \"service\":\"\", \"schedule\":[{\"date\":\"YYYY-MM-DD\", \"startTime\":\"HH:MM\", \"endTime\":\"HH:MM\"}]}";

                    try {
                        const jsonText = await callGemini(base64, prompt);
                        const res = JSON.parse(jsonText);
                        if (type === 'HELPER') setHelpers([...helpers, { id: Date.now().toString(), ...res }]);
                        else setUsers([...users, { id: Date.now().toString(), ...res }]);
                        setStatus('æˆåŠŸï¼');
                    } catch (err) {
                        setStatus(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
                        console.error(err);
                    } finally { setLoading(false); }
                };
            };

            return (
                <div className="max-w-4xl mx-auto my-10 bg-white shadow-xl rounded-3xl overflow-hidden border">
                    <div className="bg-slate-900 p-6 flex justify-between items-center text-white">
                        <h1 className="font-bold italic">CARE MATCH FINAL</h1>
                        <input type="password" placeholder="API Key" className="bg-slate-800 p-2 rounded text-xs w-64 outline-none border border-slate-700" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
                    </div>
                    <div className="p-10 space-y-8">
                        <div className="flex gap-4">
                            <label className="flex-1 bg-blue-600 text-white p-10 rounded-3xl text-center cursor-pointer hover:bg-blue-700 transition-all font-bold">
                                ğŸ‘¤ ãƒ˜ãƒ«ãƒ‘ãƒ¼è¡¨
                                <input type="file" className="hidden" onChange={(e)=>handleFileUpload(e, 'HELPER')} />
                            </label>
                            <label className="flex-1 bg-emerald-600 text-white p-10 rounded-3xl text-center cursor-pointer hover:bg-emerald-700 transition-all font-bold">
                                ğŸ  åˆ©ç”¨è€…è¡¨
                                <input type="file" className="hidden" onChange={(e)=>handleFileUpload(e, 'USER')} />
                            </label>
                        </div>
                        <div className="text-center font-bold text-slate-400">{loading ? 'AIãŒè€ƒãˆä¸­...' : status}</div>
                        <div className="bg-slate-50 p-6 rounded-2xl">
                            <h2 className="font-bold mb-4">ç™»éŒ²æ¸ˆã¿äººæ•°: ãƒ˜ãƒ«ãƒ‘ãƒ¼{helpers.length}å / åˆ©ç”¨è€…{users.length}å</h2>
                            <div className="text-xs text-slate-400">â€»ã“ã“ã«åå‰ãŒå‡ºã‚Œã°æˆåŠŸã§ã™ã€‚</div>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

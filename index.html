<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CARE MATCH FINAL</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [helpers, setHelpers] = useState(() => JSON.parse(localStorage.getItem('cm_v12_h') || '[]'));
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('cm_v12_u') || '[]'));
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('cm_v12_k') || '');
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('Ready');

            useEffect(() => {
                localStorage.setItem('cm_v12_h', JSON.stringify(helpers));
                localStorage.setItem('cm_v12_u', JSON.stringify(users));
                localStorage.setItem('cm_v12_k', apiKey);
            }, [helpers, users, apiKey]);

            const callGemini = async (base64, prompt) => {
                // ã€æœ€çµ‚ä¿®æ­£ã€‘URLã‹ã‚‰ models/ ã‚’æŠœãã€ãƒ‘ã‚¹ã®æœ€å¾Œã«ãƒ¢ãƒ‡ãƒ«åã‚’çµåˆã™ã‚‹
                // Google APIã®æœ€ã‚‚æ¨™æº–çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå½¢å¼ã§ã™
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: "image/jpeg", data: base64 } },
                                { text: prompt + "\nJSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚" }
                            ]
                        }]
                    })
                });
                
                const data = await response.json();
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ç”»é¢ã«å‡ºã™ã‚ˆã†ã«å¼·åŒ–
                if (data.error) {
                    throw new Error(`${data.error.message} (Code: ${data.error.code})`);
                }
                
                return data.candidates[0].content.parts[0].text;
            };

            const handleFileUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                setLoading(true);
                setStatus('AIé€šä¿¡ä¸­...');
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    const prompt = "ç”»åƒã‹ã‚‰ã€æ°å(name)ã¨ã€æ—¥ä»˜ãƒ»é–‹å§‹æ™‚é–“ãƒ»çµ‚äº†æ™‚é–“ã®ãƒªã‚¹ãƒˆ(schedule)ã‚’JSONã§æŠœãå‡ºã—ã¦ãã ã•ã„ã€‚";

                    try {
                        const jsonText = await callGemini(base64, prompt);
                        const cleanJson = jsonText.match(/\{[\s\S]*\}|\[[\s\S]*\]/)[0];
                        const res = JSON.parse(cleanJson);
                        if (type === 'HELPER') setHelpers([...helpers, { id: Date.now().toString(), ...res }]);
                        else setUsers([...users, { id: Date.now().toString(), ...res }]);
                        setStatus('èª­ã¿è¾¼ã¿æˆåŠŸï¼');
                    } catch (err) {
                        setStatus(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
                    } finally { setLoading(false); }
                };
            };

            return (
                <div className="max-w-2xl mx-auto my-10 bg-white shadow-2xl rounded-[3rem] p-10 border border-slate-200">
                    <header className="mb-8 flex justify-between items-center border-b pb-6">
                        <h1 className="font-black italic text-2xl text-slate-800 tracking-tighter">CARE MATCH</h1>
                        <input type="password" placeholder="API Key" className="bg-slate-50 p-2 rounded-xl text-xs w-48 outline-none border" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
                    </header>

                    <div className="grid grid-cols-2 gap-6 mb-10">
                        <label className="flex flex-col items-center justify-center p-8 bg-blue-600 text-white rounded-[2.5rem] cursor-pointer hover:bg-blue-700 shadow-lg transition-transform active:scale-95">
                            <span className="text-4xl mb-2">ğŸ‘¤</span>
                            <span className="font-bold text-xs uppercase">ãƒ˜ãƒ«ãƒ‘ãƒ¼èª­è¾¼</span>
                            <input type="file" className="hidden" onChange={(e)=>handleFileUpload(e, 'HELPER')} />
                        </label>
                        <label className="flex flex-col items-center justify-center p-8 bg-emerald-600 text-white rounded-[2.5rem] cursor-pointer hover:bg-emerald-700 shadow-lg transition-transform active:scale-95">
                            <span className="text-4xl mb-2">ğŸ </span>
                            <span className="font-bold text-xs uppercase">åˆ©ç”¨è€…èª­è¾¼</span>
                            <input type="file" className="hidden" onChange={(e)=>handleFileUpload(e, 'USER')} />
                        </label>
                    </div>

                    <div className={`p-6 rounded-[2rem] text-center font-bold mb-6 ${status.includes('ã‚¨ãƒ©ãƒ¼') ? 'bg-red-50 text-red-500' : 'bg-slate-50 text-blue-500'}`}>
                        {status}
                    </div>

                    <div className="space-y-4">
                        {helpers.concat(users).map(item => (
                            <div key={item.id} className="p-4 bg-white border border-slate-100 shadow-sm rounded-2xl font-bold text-slate-600">
                                {item.name ? `âœ“ ${item.name} ã•ã‚“` : 'è§£æä¸­...'}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
